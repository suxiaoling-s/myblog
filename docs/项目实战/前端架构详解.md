# 前端架构详解

## 概述

前端采用 Vue.js 3 组合式 API 构建，提供现代化的用户界面。主要功能包括：
- 用户登录/注册
- 雷达数据实时展示
- 时间轴播放控制
- 区域和站点筛选
- 图片缩放和预览

## 核心组件

### 1. 路由配置 (`router/index.js`)

使用 Vue Router 4 进行路由管理：

- `/login`: 登录页面（公开）
- `/register`: 注册页面（公开）
- `/radar/mosaic`: 雷达拼图模式（需认证）
- `/radar/single`: 单站雷达模式（需认证）

**路由守卫**:
- 检查 Token 进行认证
- 未认证用户重定向到登录页
- 已登录用户访问登录页重定向到首页

### 2. 主应用组件 (`App.vue`)

根组件，包含路由视图容器。

### 3. 登录组件 (`Login.vue`)

用户登录界面：
- 用户名/密码输入
- 验证码显示和输入
- 登录请求处理
- Token 存储到 localStorage

### 4. 注册组件 (`Register.vue`)

用户注册界面：
- 用户名/密码输入
- 验证码校验
- 注册请求处理
- 成功后跳转登录

### 5. 雷达展示组件 (`RadarView.vue`) - 核心组件

这是最复杂的组件，包含所有雷达展示功能。

#### 组件结构

**模板部分**:
1. **导航栏** (`header`):
   - 标题和副标题
   - 模式切换标签（拼图/单站）
   - 用户信息和操作按钮

2. **控制面板** (`control-panel`):
   - 雷达类型选择（拼图/单站）
   - 站点选择（单站模式）
   - 时间范围选择
   - 缩放控制
   - 刷新按钮

3. **拼图工具栏** (`mosaic-toolbar`):
   - 区域选择下拉框
   - 时间范围选择器
   - 缩放控制

4. **主视图区域** (`viewer-layout`):
   - 左侧：时间列表（产品制作时间）
   - 中间：雷达图像展示区域
   - 右侧：快捷时间段选择

5. **播放控制面板** (`modern-playback-panel`):
   - 播放控制按钮（开始/上一帧/播放/暂停/下一帧/结束）
   - 当前时间显示
   - 速度控制（加速/减速）
   - 循环播放开关
   - 时间轴滑块

#### 核心功能实现

**1. 数据加载**:

```javascript
// 加载雷达数据
loadRadarData(useCache, options)
  - 支持缓存机制
  - 支持时间范围筛选
  - 支持区域/站点筛选
  - 异步加载，不阻塞 UI

// 加载单站雷达数据
loadSingleRadarData(useCache, options)
  - 站点切换时快速加载最新数据
  - 后台加载完整数据
  - 智能合并数据
```

**2. 图片预加载**:

```javascript
// 智能预加载附近帧
preloadNearbyFrames(index)
  - 根据播放状态调整预加载范围
  - 批量加载，控制并发
  - 延迟加载，不阻塞主线程

// 预加载所有图片
preloadAllImages()
  - 限制时间范围（最多30天）
  - 分批加载
  - 播放时优先加载
```

**3. 缓存机制**:

```javascript
// 数据缓存
- 使用 Map 和 localStorage
- TTL: 15分钟
- 自动清理过期缓存
- 缓存键：模式-区域/站点-时间范围

// 图片缓存
- 使用 Map 存储已加载图片
- 避免重复加载
- 自动应用图片元数据
```

**4. 播放控制**:

```javascript
// 自动播放
startAutoPlay()
  - 设置定时器
  - 自动切换到下一帧
  - 支持循环播放
  - 播放时增强预加载

// 播放速度控制
- 默认: 100ms/帧 (约10fps)
- 可调节范围: 100ms - 2000ms
- 实时更新播放间隔
```

**5. 响应式状态管理**:

使用 Vue 3 的 `ref` 和 `computed`:

```javascript
// 核心状态
- imageList: 图像列表
- currentIndex: 当前索引
- radarMode: 雷达模式（拼图/单站）
- region: 区域选择
- selectedStation: 选中的站点
- isPlaying: 播放状态
- dateRange: 时间范围

// 计算属性
- currentImage: 当前显示的图像
- timeListItems: 时间列表项
- quickRangeOptions: 快捷时间段选项
- provinceOptions: 省份选项
- cityOptions: 城市选项
```

**6. 性能优化**:

- **防抖节流**: 站点/区域切换使用防抖（300ms）
- **请求取消**: 使用 AbortController 取消过时请求
- **懒加载**: 图片使用 `loading="lazy"`
- **批量操作**: 预加载使用批量处理
- **条件渲染**: 使用 `v-if` 减少 DOM 节点

**7. 用户体验优化**:

- **加载状态**: 显示加载动画和提示信息
- **错误处理**: 友好的错误提示
- **空状态**: 无数据时显示提示
- **响应式布局**: 适配不同屏幕尺寸
- **快捷键支持**: （可扩展）

### 6. API 调用封装 (`api/radar.js`)

封装所有后端 API 调用：

```javascript
// 认证相关
- login(username, password)
- register(data)
- changePassword(data)

// 雷达拼图 API
- getRadarTimeline(hours, region)
- getRadarByRange(startISO, endISO, region, page, pageSize)
- getTimeRange(region)
- getLatestByRegion(region)

// 单站雷达 API
- getSingleRadarStations(province, city)
- getSingleRadarList(params)
- getSingleRadarLatest(stationCode)
- getSingleRadarTimeRange(params)
```

所有 API 调用都包含：
- Token 自动添加
- 错误处理
- 请求取消支持（AbortSignal）

## 状态管理

使用 Vue 3 组合式 API 进行状态管理：

- **本地状态**: 使用 `ref` 和 `reactive`
- **计算属性**: 使用 `computed`
- **副作用**: 使用 `watch` 和 `watchEffect`
- **生命周期**: 使用 `onMounted`、`onUnmounted`

## 样式设计

使用 Scoped CSS 和现代 CSS 特性：

- **Flexbox 布局**: 响应式布局
- **CSS 变量**: （可扩展）
- **过渡动画**: 平滑的状态切换
- **响应式设计**: 媒体查询适配移动端

## 构建和部署

### 开发环境

```bash
npm install
npm run dev  # Vite 开发服务器
```

### 生产构建

```bash
npm run build  # 构建到 dist/ 目录
```

### Docker 构建

使用多阶段构建：
1. 构建阶段：安装依赖，构建项目
2. 运行阶段：使用 Nginx 提供静态文件服务

## 浏览器兼容性

- 现代浏览器（Chrome、Firefox、Safari、Edge）
- 支持 ES6+ 特性
- 需要支持 async/await

## 性能指标

- **首屏加载**: < 2s
- **图片预加载**: 智能分批，不阻塞主线程
- **播放流畅度**: 60fps（取决于数据量）
- **内存使用**: 图片缓存限制，自动清理

## 未来优化方向

1. **虚拟滚动**: 时间列表使用虚拟滚动
2. **Web Workers**: 图片处理移到 Worker
3. **Service Worker**: 离线缓存支持
4. **懒加载路由**: 路由级别的代码分割
5. **PWA**: 渐进式 Web 应用支持

