# 后端架构详解

## 概述

后端采用 FastAPI 框架构建，提供 RESTful API 服务。主要职责包括：
- 用户认证和授权
- 雷达数据查询和管理
- 静态文件服务
- 数据库操作

## 核心模块

### 1. API 路由模块 (`api/`)

#### 认证路由 (`api/auth.py`)

提供用户认证相关的 API 端点：

- **POST `/api/login`**: 用户登录
  - 验证用户名和密码
  - 返回 JWT access_token 和 refresh_token
  
- **POST `/api/register`**: 用户注册
  - 验证码校验
  - 用户名唯一性检查
  - 密码加密存储

- **POST `/api/change-password`**: 修改密码
  - 需要认证
  - 验证当前密码
  - 更新密码哈希

- **GET `/api/captcha`**: 获取验证码 ID
- **GET `/api/captcha/{captcha_id}/image`**: 获取验证码图片

- **POST `/api/refresh`**: 刷新 Token
  - 使用 refresh_token 换取新的 access_token

#### 雷达数据路由 (`api/routes.py`)

提供雷达数据查询 API，所有接口都需要认证：

**雷达拼图接口**:
- `GET /api/radar/latest`: 获取最新雷达图像
- `GET /api/radar/list`: 获取雷达图像列表（支持分页、时间范围、区域筛选）
- `GET /api/radar/timeline`: 获取时间轴数据（最近 N 小时）
- `GET /api/radar/time-range`: 获取数据时间范围
- `GET /api/radar/latest-by-region`: 快速获取指定区域最新数据

**单站雷达接口**:
- `GET /api/radar/single/stations`: 获取单站雷达站点列表
- `GET /api/radar/single/list`: 获取单站雷达图像列表
- `GET /api/radar/single/latest`: 获取指定站点最新图像
- `GET /api/radar/single/time-range`: 获取单站数据时间范围

### 2. 数据库模块 (`database/`)

#### 数据模型 (`database/models.py`)

定义了三个主要数据模型：

**RadarImageModel** - 雷达拼图图像模型
```python
- id: 主键
- filename: 文件名（唯一索引）
- filepath: 文件路径
- timestamp: 时间戳（索引）
- file_size: 文件大小
- file_format: 文件格式
- region: 区域（索引，如 EAST、NORTH 等）
- created_at: 创建时间
- updated_at: 更新时间
```

**SingleRadarImageModel** - 单站雷达图像模型
```python
- id: 主键
- station_code: 站点编码（索引）
- filename: 文件名（唯一索引）
- filepath: 文件路径
- timestamp: 时间戳（索引）
- file_size: 文件大小
- file_format: 文件格式
- province: 省份（索引）
- city: 城市（索引）
- created_at: 创建时间
- updated_at: 更新时间
```

**UserModel** - 用户模型
```python
- id: 主键
- username: 用户名（唯一索引）
- password_hash: 密码哈希（bcrypt）
- is_active: 是否激活
- created_at: 创建时间
- updated_at: 更新时间
```

#### 数据库连接 (`database/connection.py`)

- 使用 SQLAlchemy 异步引擎
- 配置连接池
- 提供 `AsyncSessionLocal` 会话工厂

### 3. 业务逻辑服务 (`services/`)

#### 雷达扫描服务 (`services/radar_scanner.py`)

核心业务逻辑类 `RadarScanner`，负责：

1. **文件名时间戳解析** (`parse_filename_timestamp`)
   - 支持多种时间格式
   - 从文件名提取时间信息

2. **数据查询方法**:
   - `get_latest_image()`: 获取最新图像
   - `get_image_list()`: 获取图像列表（支持分页、筛选）
   - `get_time_range()`: 获取时间范围
   - `get_single_image_list()`: 获取单站图像列表
   - `get_single_station_list()`: 获取站点列表
   - `get_single_time_range()`: 获取单站时间范围

3. **数据转换**:
   - `_image_to_dict()`: 模型转字典
   - `_single_image_to_dict()`: 单站模型转字典
   - URL 生成（基于配置的远程基础 URL）

### 4. 工具模块 (`utils/`)

#### 认证工具 (`utils/auth.py`)

- `authenticate_user()`: 用户认证
- `create_access_token()`: 创建访问令牌（30分钟）
- `create_refresh_token()`: 创建刷新令牌（7天）
- `get_password_hash()`: 密码哈希（bcrypt）
- `verify_password()`: 密码验证
- `decode_refresh_token()`: 解码刷新令牌

#### 验证码工具 (`utils/captcha.py`)

- `generate_captcha()`: 生成验证码图片和 ID
- `verify_captcha()`: 验证验证码
- `cleanup_expired_captcha()`: 清理过期验证码

#### 依赖注入 (`utils/dependencies.py`)

- `get_current_user_from_token()`: 从 Token 获取当前用户
- `get_session()`: 获取数据库会话

### 5. 应用入口 (`main.py`)

FastAPI 应用配置：

```python
- CORS 中间件配置
- 静态文件挂载（雷达数据目录）
- 路由注册
- 数据库初始化（启动事件）
- 健康检查接口
```

## 数据库索引优化

为了提高查询性能，创建了以下索引：

1. **RadarImageModel**:
   - `idx_timestamp_filename`: (timestamp, filename) 复合索引
   - `idx_region_timestamp`: (region, timestamp) 复合索引
   - `idx_region_timestamp_desc`: (region, timestamp DESC) 优化最新数据查询

2. **SingleRadarImageModel**:
   - `idx_single_station_timestamp`: (station_code, timestamp) 复合索引
   - `idx_single_province_city`: (province, city) 复合索引

## 安全机制

1. **密码安全**:
   - 使用 bcrypt 加密存储
   - 密码不直接存储明文

2. **Token 安全**:
   - JWT Token 签名验证
   - Token 过期时间控制
   - Refresh Token 机制

3. **验证码**:
   - 注册时验证码校验
   - 验证码过期时间（5分钟）
   - 内存存储，自动清理

4. **API 认证**:
   - 雷达数据接口需要 Bearer Token
   - Token 验证失败返回 401

## 日志系统

使用 Loguru 进行日志记录：

- 用户登录/注册日志
- API 错误日志
- 数据库操作日志
- 日志文件自动轮转

## 配置管理

通过环境变量配置：

- `DATABASE_URL`: 数据库连接字符串
- `RADAR_DATA_PATH`: 雷达数据文件路径
- `RADAR_REMOTE_BASE_URL`: 远程基础 URL（用于生成图片 URL）
- `CORS_ORIGINS`: CORS 允许的源
- `SECRET_KEY`: JWT 签名密钥

## 性能优化

1. **异步 I/O**:
   - 使用 async/await 异步操作
   - 数据库异步查询（asyncpg）

2. **查询优化**:
   - 数据库索引
   - 分页查询
   - 条件筛选优化

3. **静态文件**:
   - FastAPI 静态文件服务
   - 直接文件访问，减少后端处理

## 错误处理

- 统一的异常处理
- HTTP 状态码规范
- 详细的错误信息返回
- 日志记录错误详情

