# 后端架构详解

## 概述

后端采用 FastAPI 框架构建，提供 RESTful API 服务。主要职责包括：
- 用户认证和授权
- 雷达数据查询和管理
- 静态文件服务
- 数据库操作

## 核心模块

### 1. API 路由模块 (`api/`)

#### 认证路由 (`api/auth.py`)

提供用户认证相关的 API 端点：

**POST `/api/login`** - 用户登录

```python
@auth_router.post("/login", response_model=LoginResponse)
async def login(login_data: LoginRequest):
    """用户登录"""
    async with AsyncSessionLocal() as session:
        user = await authenticate_user(session, login_data.username, login_data.password)
        
        if not user:
            logger.warning(f"登录失败: 用户 {login_data.username} 认证失败")
            raise HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED,
                detail="用户名或密码错误"
            )
        
        # 创建访问令牌（30分钟）和刷新令牌（7天）
        access_token = create_access_token(data={"sub": user.username})
        refresh_token = create_refresh_token(data={"sub": user.username})
        
        logger.info(f"用户 {user.username} 登录成功")
        
        return LoginResponse(
            access_token=access_token,
            refresh_token=refresh_token,
            token_type="bearer",
            username=user.username
        )
```

**POST `/api/register`** - 用户注册

```python
@auth_router.post("/register", response_model=RegisterResponse)
async def register(register_data: RegisterRequest):
    """用户注册"""
    # 验证验证码
    if not verify_captcha(register_data.captcha_id, register_data.captcha_text):
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="验证码错误或已过期"
        )
    
    async with AsyncSessionLocal() as session:
        # 检查用户名是否已存在
        stmt = select(UserModel).where(UserModel.username == register_data.username)
        result = await session.execute(stmt)
        existing_user = result.scalar_one_or_none()
        
        if existing_user:
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail="用户名已存在"
            )
        
        # 创建新用户（密码使用 bcrypt 加密）
        password_hash = get_password_hash(register_data.password)
        new_user = UserModel(
            username=register_data.username,
            password_hash=password_hash,
            is_active=True
        )
        
        session.add(new_user)
        await session.commit()
        return RegisterResponse(message="注册成功", username=new_user.username)
```

**POST `/api/change-password`** - 修改密码（需要认证）

**GET `/api/captcha`** - 获取验证码 ID

**GET `/api/captcha/{captcha_id}/image`** - 获取验证码图片

**POST `/api/refresh`** - 刷新 Token

#### 雷达数据路由 (`api/routes.py`)

提供雷达数据查询 API，所有接口都需要认证：

**雷达拼图接口**:
- `GET /api/radar/latest`: 获取最新雷达图像
- `GET /api/radar/list`: 获取雷达图像列表（支持分页、时间范围、区域筛选）
- `GET /api/radar/timeline`: 获取时间轴数据（最近 N 小时）
- `GET /api/radar/time-range`: 获取数据时间范围
- `GET /api/radar/latest-by-region`: 快速获取指定区域最新数据

**单站雷达接口**:
- `GET /api/radar/single/stations`: 获取单站雷达站点列表
- `GET /api/radar/single/list`: 获取单站雷达图像列表
- `GET /api/radar/single/latest`: 获取指定站点最新图像
- `GET /api/radar/single/time-range`: 获取单站数据时间范围

### 2. 数据库模块 (`database/`)

#### 数据模型 (`database/models.py`)

定义了三个主要数据模型：

**RadarImageModel** - 雷达拼图图像模型

```python
from datetime import datetime, timezone
from sqlalchemy import Column, Integer, String, DateTime, BigInteger, Index
from database.base import Base

class RadarImageModel(Base):
    """雷达图像数据模型"""
    __tablename__ = "radar_images"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    filename = Column(String(255), unique=True, nullable=False, index=True)
    filepath = Column(String(512), nullable=False)
    timestamp = Column(DateTime(timezone=True), nullable=False, index=True)
    file_size = Column(BigInteger, nullable=False)
    file_format = Column(String(50), nullable=True)
    region = Column(String(50), nullable=True, index=True)  # 区域字段
    created_at = Column(DateTime(timezone=True), 
                       default=lambda: datetime.now(timezone.utc), 
                       nullable=False)
    updated_at = Column(DateTime(timezone=True), 
                       default=lambda: datetime.now(timezone.utc), 
                       onupdate=lambda: datetime.now(timezone.utc), 
                       nullable=False)
    
    # 创建复合索引以优化查询
    __table_args__ = (
        Index('idx_timestamp_filename', 'timestamp', 'filename'),
        Index('idx_region_timestamp', 'region', 'timestamp'),
        Index('idx_region_timestamp_desc', 'region', 'timestamp', 
              postgresql_ops={'timestamp': 'DESC'}),
    )
```

**SingleRadarImageModel** - 单站雷达图像模型

```python
class SingleRadarImageModel(Base):
    """单站雷达图像数据模型"""
    __tablename__ = "single_radar_images"

    id = Column(Integer, primary_key=True, autoincrement=True)
    station_code = Column(String(50), nullable=False, index=True)
    filename = Column(String(255), unique=True, nullable=False, index=True)
    filepath = Column(String(512), nullable=False)
    timestamp = Column(DateTime(timezone=True), nullable=False, index=True)
    file_size = Column(BigInteger, nullable=False)
    file_format = Column(String(50), nullable=True)
    province = Column(String(100), nullable=True, index=True)
    city = Column(String(100), nullable=True, index=True)
    created_at = Column(DateTime(timezone=True), 
                       default=lambda: datetime.now(timezone.utc), 
                       nullable=False)
    updated_at = Column(DateTime(timezone=True), 
                       default=lambda: datetime.now(timezone.utc),
                       onupdate=lambda: datetime.now(timezone.utc), 
                       nullable=False)

    __table_args__ = (
        Index('idx_single_station_timestamp', 'station_code', 'timestamp'),
        Index('idx_single_province_city', 'province', 'city'),
    )
```

**UserModel** - 用户模型

```python
from sqlalchemy import Boolean

class UserModel(Base):
    """用户模型"""
    __tablename__ = "users"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    username = Column(String(50), unique=True, nullable=False, index=True)
    password_hash = Column(String(255), nullable=False)  # bcrypt加密后的密码
    is_active = Column(Boolean, default=True, nullable=False)
    created_at = Column(DateTime(timezone=True), 
                       default=lambda: datetime.now(timezone.utc), 
                       nullable=False)
    updated_at = Column(DateTime(timezone=True), 
                       default=lambda: datetime.now(timezone.utc), 
                       onupdate=lambda: datetime.now(timezone.utc), 
                       nullable=False)
```

#### 数据库连接 (`database/connection.py`)

使用 SQLAlchemy 异步引擎和连接池：

```python
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
from sqlalchemy.orm import sessionmaker
import os

# 创建异步引擎
engine = create_async_engine(
    os.getenv("DATABASE_URL"),
    pool_pre_ping=True,  # 连接前检查连接是否有效
    pool_size=10,        # 连接池大小
    max_overflow=20      # 最大溢出连接数
)

# 创建异步会话工厂
AsyncSessionLocal = sessionmaker(
    engine, 
    class_=AsyncSession, 
    expire_on_commit=False
)

async def init_database():
    """初始化数据库（创建表）"""
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)
```

### 3. 业务逻辑服务 (`services/`)

#### 雷达扫描服务 (`services/radar_scanner.py`)

核心业务逻辑类 `RadarScanner`，负责：

**数据查询（核心功能）**

- `get_latest_image()`: 获取最新图像
- `get_image_list()`: 获取图像列表（支持分页、筛选）
- `get_time_range()`: 获取时间范围
- `get_single_image_list()`: 获取单站图像列表
- `get_single_station_list()`: 获取站点列表
- `get_single_time_range()`: 获取单站时间范围

**数据转换（结果格式化）**

- `_image_to_dict()`: 模型转字典
- `_single_image_to_dict()`: 单站模型转字典
- URL 生成（基于配置的远程基础 URL）

**文件名时间戳解析 (`parse_filename_timestamp`)（底层工具）**

- 支持多种时间格式
- 从文件名提取时间信息

### 4. 工具模块 (`utils/`)

#### 认证工具 (`utils/auth.py`)

- `authenticate_user()`: 用户认证
- `create_access_token()`: 创建访问令牌（30分钟）
- `create_refresh_token()`: 创建刷新令牌（7天）
- `get_password_hash()`: 密码哈希（bcrypt）
- `verify_password()`: 密码验证
- `decode_refresh_token()`: 解码刷新令牌

#### 验证码工具 (`utils/captcha.py`)

- `generate_captcha()`: 生成验证码图片和 ID
- `verify_captcha()`: 验证验证码
- `cleanup_expired_captcha()`: 清理过期验证码

#### 依赖注入 (`utils/dependencies.py`)

- `get_current_user_from_token()`: 从 Token 获取当前用户
- `get_session()`: 获取数据库会话

### 5. 应用入口 (`main.py`)

FastAPI 应用配置：

```python
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from fastapi.staticfiles import StaticFiles
import os
from api.routes import radar_router
from api.auth import auth_router
from database.connection import init_database

app = FastAPI(title="Radar Live CN API", version="1.0.0")

# CORS 配置
app.add_middleware(
    CORSMiddleware,
    allow_origins=os.getenv("CORS_ORIGINS", "*").split(","),
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# 挂载静态文件目录
radar_data_path = os.getenv("RADAR_DATA_PATH", "/mnt/data/radar/china/MOSAIC")
if os.path.exists(radar_data_path):
    app.mount("/china", StaticFiles(directory=radar_data_path, html=False), 
              name="radar-data")

# 注册路由
app.include_router(auth_router, prefix="/api", tags=["auth"])
app.include_router(radar_router, prefix="/api", tags=["radar"])

@app.on_event("startup")
async def startup_event():
    """应用启动时初始化数据库"""
    await init_database()

@app.get("/")
async def root():
    """健康检查接口"""
    return {
        "status": "ok",
        "service": "Radar Live CN",
        "timestamp": datetime.now(timezone.utc).isoformat()
    }
```

## 数据库索引优化

为了提高查询性能，创建了以下索引：

**RadarImageModel**:
- `idx_timestamp_filename`: (timestamp, filename) 复合索引
- `idx_region_timestamp`: (region, timestamp) 复合索引
- `idx_region_timestamp_desc`: (region, timestamp DESC) 优化最新数据查询

**SingleRadarImageModel**:
- `idx_single_station_timestamp`: (station_code, timestamp) 复合索引
- `idx_single_province_city`: (province, city) 复合索引

## 安全机制

**密码安全**:
- 使用 bcrypt 加密存储
- 密码不直接存储明文

**Token 安全**:
- JWT Token 签名验证
- Token 过期时间控制
- Refresh Token 机制

**验证码**:
- 注册时验证码校验
- 验证码过期时间（5分钟）
- 内存存储，自动清理

**API 认证**:
- 雷达数据接口需要 Bearer Token
- Token 验证失败返回 401

## 日志系统

使用 Loguru 进行日志记录：

- 用户登录/注册日志
- API 错误日志
- 数据库操作日志
- 日志文件自动轮转

## 配置管理

通过环境变量配置：

- `DATABASE_URL`: 数据库连接字符串
- `RADAR_DATA_PATH`: 雷达数据文件路径
- `RADAR_REMOTE_BASE_URL`: 远程基础 URL（用于生成图片 URL）
- `CORS_ORIGINS`: CORS 允许的源
- `SECRET_KEY`: JWT 签名密钥

## 性能优化

1. **异步 I/O**:
   - 使用 async/await 异步操作
   - 数据库异步查询（asyncpg）

2. **查询优化**:
   - 数据库索引
   - 分页查询
   - 条件筛选优化

3. **静态文件**:
   - FastAPI 静态文件服务
   - 直接文件访问，减少后端处理

## 错误处理

统一的异常处理和错误响应：

```python
from fastapi import HTTPException, status
from sqlalchemy.exc import SQLAlchemyError

@radar_router.get("/radar/latest")
async def get_latest_radar():
    try:
        scanner = get_scanner()
        latest = await scanner.get_latest_image()
        if not latest:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND, 
                detail="No radar images found"
            )
        return latest
    except SQLAlchemyError as e:
        logger.error(f"Database error: {str(e)}")
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Database error: {str(e)}"
        )
    except ValueError as e:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail=str(e)
        )
```

**错误响应格式**:
```json
{
  "detail": "错误描述信息"
}
```

**HTTP 状态码规范**:
- `200`: 成功
- `400`: 请求参数错误
- `401`: 未认证或 Token 无效
- `404`: 资源不存在
- `500`: 服务器内部错误

